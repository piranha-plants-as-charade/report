\tikzstyle{startstop} = [
    rectangle, rounded corners = 0.58cm,
    text centered,
    text width=1.75cm,
    inner sep=0.2cm,
    draw=black,
    fill=gray!20
]

\tikzstyle{io} = [
    trapezium, 
    % trapezium stretches=true, % A later addition
    trapezium left angle=70, 
    trapezium right angle=110, 
    text width=1.75cm, 
    inner sep=0.2cm,
    text centered, 
    draw=black,
    fill=gray!20
]

\tikzstyle{document} = [
    tape,
    tape bend top=none,
    text centered,
    text width=1.75cm,
    inner sep=0.2cm,
    draw=black,
    fill=gray!20
]

\tikzstyle{process} = [
    rectangle, 
    text centered, 
    text width=1.75cm,
    inner sep=0.2cm,
    draw=black, 
]

\tikzstyle{arrow} = [
    thick,->,>=stealth,
    text centered
]


\begin{tikzpicture}[node distance=1.5cm]

    \node (input) [startstop] {Input melody};
    \node (hpss) [process, below = of input] {HPSS};
    \node (onset) [process, below = of hpss, xshift=1.75cm, yshift=-0.25cm] {Onset detection};
    \node (pyin) [process, below = of hpss, xshift=-1.75cm, yshift=-0.5cm] {PYIN};
    \node (melody) [process, below = of onset, xshift=-1.75cm] {Melody builder};
    
    \draw [arrow] (input) -- node[anchor=center, fill=white, yshift=0.175cm]{digital signal} (hpss);
    \draw [arrow] (hpss) -| node[anchor=center, fill=white, yshift=-1.1cm, text width=2cm]{percussive component} (onset);
    \draw [arrow] (hpss) -| node[anchor=center, fill=white, yshift=-1.25cm, text width=2cm]{harmonic component} (pyin);
    \draw [arrow] (pyin) |- node[anchor=center, fill=white, yshift=1.25cm]{pitches} (melody);
    \draw [arrow] (onset) -- ($(onset.south) - (0, 0.75cm)$) node[anchor=center, fill=white, xshift=-0.85cm]{onsets} -| (melody);

    \node (viterbi) [process, right = of input, xshift=2.75cm, yshift=-0.25cm] {Viterbi};

    \node (melody_ctx) [right = of melody, xshift=0.8cm] {melody};

    \draw [arrow] (melody) -- (melody_ctx) |- (viterbi);

    \node (percussion) [process, below = of viterbi, yshift=-0.25cm] {Percussion generator};
    \node (piano) [process, below = of percussion] {Piano generator};
    \node (voice) [process, below = of piano] {Voice generator};
    \node (harmony_ctx) [right = of viterbi, xshift=-2cm, yshift=-1.25cm] {chord progression};

    \draw [arrow] (viterbi) -| (harmony_ctx) |- (percussion);
    \draw [arrow] (harmony_ctx) |- (piano);
    \draw [arrow] (harmony_ctx) |- (voice);
    \draw [arrow] (melody_ctx) |- (percussion);
    \draw [arrow] (melody_ctx) |- (piano);
    \draw [arrow] (melody_ctx) |- (voice);

    \node (sample_data) [document, below = of melody, yshift=0.6cm] {Custom sample library};
    \node (soundfont) [document, right = of sample_data, xshift=10.75cm] {Soundfont library};

    \node (midi) [process, right = of percussion, xshift=2.25cm, yshift=-1.4cm] {MIDI-based export};
    \node (sample) [process, right = of voice, xshift=2.25cm, yshift=1.4cm] {Sample-based export};
    \node (output) [startstop, right = of input, xshift=8.664cm] {Output song};
    \node (export_combined) [below = of output, yshift=0.5cm, text centered] {digital signal};
    
    \draw [arrow] (sample_data) -| node[anchor=center, fill=white, xshift=-6cm]{audio samples} (sample);
    \draw [arrow] (soundfont) |- node[anchor=center, fill=white, yshift=-4.45cm]{soundfont} (midi);
    \draw [arrow, preaction={draw=white, -, line width=12pt}] (percussion) |- node[anchor=center, fill=white, xshift=3.3cm, text width=2cm]{instrument parts} (midi);
    \draw [arrow] (piano) |- (midi);
    \draw [arrow, preaction={draw=white, -, line width=12pt}] (voice) |- node[anchor=center, fill=white, xshift=3.3cm]{voice parts} (sample);
    \draw [arrow] (midi) -- (export_combined) -- (output);
    \draw [arrow, preaction={draw=white, -, line width=12pt}] (sample) -- ($(sample.east) - (-1.75cm, 0)$) |- (export_combined) -- (output);
    
    \draw[red] ($(hpss.north west)+(-2.15cm, 0.4cm)$) rectangle ($(melody.south east)+(2.15cm, -0.4cm)$);
    \node [fill=white, text=red, anchor=west] at ($(hpss.north west)+(-2.35cm, 0.4cm)$) {\footnotesize I. Melody extraction};

    \draw[red] ($(viterbi.north west)+(-0.4cm, 0.4cm)$) rectangle ($(viterbi.south east)+(0.4cm, -0.4cm)$);
    \node [fill=white, text=red, anchor=west] at ($(viterbi.north west)+(-0.6cm, 0.4cm)$) {\footnotesize II. Chord generation};

    \draw[red] ($(percussion.north west)+(-0.4cm, 0.4cm)$) rectangle ($(voice.south east)+(0.4cm, -0.4cm)$);
    \node [fill=white, text=red, anchor=center] at ($(voice.south)+(0,-0.4cm)$) {\footnotesize III. Accompaniment generation};

    \draw[red] ($(midi.north west)+(-0.4cm, 0.4cm)$) rectangle ($(sample.south east)+(0.4cm, -0.6cm)$);
    \node [fill=white, text=red, anchor=west] at ($(sample.south west)+(-0.6cm, -0.6cm)$) {\footnotesize IV. Audio export};
    
\end{tikzpicture}